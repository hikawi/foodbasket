version: "3"

vars:
  FRONTENDS: frontend-home frontend-pos frontend-admin frontend-tenant

dotenv:
  - .env
  - .env.example

tasks:
  # -- Clean up Rust --
  clean:backend:
    desc: Clean up backend targets
    cmds:
      - cargo clean

  # --- Setup Tasks ---
  install:
    desc: Install all dependencies for Vue
    cmds:
      - for: { var: FRONTENDS }
        cmd: cd apps/{{.ITEM}} && pnpm install

  format:frontends:
    desc: Format all Node projects
    cmds:
      - for: { var: FRONTENDS }
        cmd: cd apps/{{.ITEM}} && pnpm format

  format:
    desc: Format all projects
    deps: [format:frontends]

  # --- Infrastructure ---
  infra:
    desc: Start Docker containers (DB, Redis, Mailpit, etc.)
    cmds:
      - docker compose up

  infra:down:
    desc: Drop Docker containers
    cmds:
      - docker compose down

  infra:kill:
    desc: Destroy all Docker containers and volumes
    cmds:
      - docker compose down -v

  # --- Linting ---
  lint:backend:
    desc: Lint backend
    cmds:
      - cargo clippy --workspace -- -D warnings

  # --- Testing ---
  test:backend:
    desc: Test the Backend
    cmds:
      - cargo test --workspace

  test:backend:ci:
    desc: (CI Only) Test Backend
    dir: apps/backend
    cmds:
      - gotestsum -f github-actions -- -coverprofile=./coverage.out $(go list ./... | grep -vE "/mocks|/postgres|/docs")

  # --- Development ---
  dev:
    desc: Start all services natively with hot-reload
    deps: [infra, dev:backend, dev:frontends]

  dev:backend:
    desc: Start the Backend in hot reload mode
    dir: apps/backend-rs
    cmds:
      - cargo watch -x check -x run

  dev:frontends:
    desc: Start all Vue apps in parallel
    cmds:
      - pnpm -r --parallel dev --host

  # -------------------------
  # Docker stuff
  # -------------------------

  build:ui:
    desc: Build packages/ui
    cmds:
      - pnpm --filter @foodbasket/ui build

  build:backend:
    desc: Run docker build on backend
    dir: apps/backend
    cmds:
      - docker build -t foodbasket-backend .

  build:home:
    desc: Run docker build on frontend-home
    dir: apps/frontend-home
    cmds:
      - docker build -t foodbasket-frontend-home .

  build:tenant:
    desc: Run docker build on frontend-tenant
    dir: apps/frontend-tenant
    cmds:
      - docker build -t foodbasket-frontend-tenant .

  build:
    desc: Build Dockerfiles
    deps: [build:backend, build:home, build:tenant]
